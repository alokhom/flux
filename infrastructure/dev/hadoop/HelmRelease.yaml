apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: hadoop
  namespace: hadoop
spec:
  interval: 30m
  chart:
    spec:
      chart: hadoop
      version: "1.2.0"
      sourceRef:
        kind: HelmRepository
        name: hadoop
        namespace: hadoop
      interval: 5m
  values:
    image:
      repository: farberg/apache-hadoop
      tag: 3.3.2
      pullPolicy: IfNotPresent

    # The version of the hadoop libraries being used in the image.
    hadoopVersion: 3.3.2
    logLevel: INFO

    # Select antiAffinity as either hard or soft, default is soft
    antiAffinity: "soft"

    hdfs:
      nameNode:
        pdbMinAvailable: 1

        resources:
          requests:
            memory: "256Mi"
            cpu: "10m"
          limits:
            memory: "600Mi"
            cpu: "400m"

      dataNode:
        # Will be used as dfs.datanode.hostname
        # You still need to set up services + ingress for every DN
        # Datanodes will expect to
        externalHostname: hadoop.systemtracker.no-ip.org
        externalDataPortRangeStart: 50500
        externalHTTPPortRangeStart: 51000

        replicas: 1

        pdbMinAvailable: 1

        resources:
          requests:
            memory: "256Mi"
            cpu: "10m"
          limits:
            memory: "600Mi"
            cpu: "500m"

      webhdfs:
        enabled: true

    yarn:
      resourceManager:
        pdbMinAvailable: 1

        resources:
          requests:
            memory: "256Mi"
            cpu: "10m"
          limits:
            memory: "400Mi"
            cpu: "200m"

      nodeManager:
        pdbMinAvailable: 1

        # The number of YARN NodeManager instances.
        replicas: 1

        # Create statefulsets in parallel (K8S 1.7+)
        parallelCreate: false

        # CPU and memory resources allocated to each node manager pod.
        # This should be tuned to fit your workload.
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "400Mi"
            cpu: "200m"

    persistence:
      nameNode:
        enabled: true
        storageClass: "standard"
        accessMode: ReadWriteOnce
        size: 10Gi

      dataNode:
        enabled: true
        storageClass: "standard"
        accessMode: ReadWriteOnce
        size: 50Gi