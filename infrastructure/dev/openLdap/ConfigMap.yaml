kind: ConfigMap
apiVersion: v1
metadata:
  name: scripts
  namespace: openldap
data:
  configure.sh: |
    #!/bin/sh
    curl -sLO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/arm64/kubectl" && chmod +x kubectl && mv ./kubectl /usr/bin/kubectl;
    echo "kubectl installed";
    sleep 2;
    PODNAME=$(kubectl -n openldap get pod -l app.kubernetes.io/name=openldap-stack-ha --field-selector=status.phase==Running -o jsonpath="{.items[0].metadata.name}")
    kubectl cp /cache/01-default-users.ldif openldap/${PODNAME}:/tmp && echo "copied ldif..";
    sleep 3;
    kubectl -n openldap exec -i -t ${PODNAME} -- ldapmodify -x -D "cn=admin,dc=systemtracker,dc=no-ip,dc=org" -w admin@Password -H ldap://localhost -f /tmp/01-default-users.ldif;
    sleep 3;
    echo "ldif executed...";
    kubectl -n openldap exec -i -t ${PODNAME} -- ldapsearch -x -D "cn=admin,dc=systemtracker,dc=no-ip,dc=org" -w admin@Password -b "uid=jsmith1,ou=People,dc=systemtracker,dc=no-ip,dc=org" "(objectclass=*)";
    sleep 5;
  
  01-default-users.ldif: |
    dn: ou=People,dc=systemtracker,dc=no-ip,dc=org
    changetype: add
    objectClass: organizationalUnit
    ou: People

    dn: ou=Group,dc=systemtracker,dc=no-ip,dc=org
    changetype: add
    objectClass: organizationalUnit
    ou: Group

    # Add John Smith to the organization
    dn: uid=jsmith1,ou=People,dc=systemtracker,dc=no-ip,dc=org
    changetype: add
    objectClass: inetOrgPerson
    description: John Smith from Accounting
    cn: John Smith
    sn: Smith
    uid: jsmith1
    userPassword: {SSHA}9eRx9GK6tD9tI3sjJqhEkuduFWVvNr3Rv3e2QA==

    dn: uid=bassa,ou=People,dc=systemtracker,dc=no-ip,dc=org
    changetype: add
    uid: bassa
    cn: bassa
    sn: 3
    objectClass: top
    objectClass: posixAccount
    objectClass: inetOrgPerson
    loginShell: /bin/bash
    homeDirectory: /home/bassa
    uidNumber: 14583102
    gidNumber: 14564100
    userPassword: {SSHA}9eRx9GK6tD9tI3sjJqhEkuduFWVvNr3Rv3e2QA==
    mail: bassa@rahasak.com
    gecos: Bassa User