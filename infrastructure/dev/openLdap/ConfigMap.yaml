kind: ConfigMap
apiVersion: v1
metadata:
  name: scripts
  namespace: openldap
data:
  configure.sh: |
    #!/bin/sh
    curl -sLO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/arm64/kubectl" && chmod +x kubectl && mv ./kubectl /usr/bin/kubectl;
    echo "kubectl installed";
    sleep 2;
    PODNAME=$(kubectl -n openldap get pod -l app.kubernetes.io/name=openldap-stack-ha --field-selector=status.phase==Running -o jsonpath="{.items[0].metadata.name}")
    kubectl cp /cache/01-default-users.ldif openldap/${PODNAME}:/tmp && echo "copied ldif..";
    sleep 3;
    kubectl -n openldap exec -i -t ${PODNAME} -- ldapmodify -a -x -D "cn=admin,dc=systemtracker,dc=no-ip,dc=org" -w admin@Password -H ldap://localhost -f /tmp/01-default-users.ldif;
    sleep 3;
    echo "ldif executed...";
    kubectl -n openldap exec -i -t ${PODNAME} -- ldapsearch -x -D "cn=admin,dc=systemtracker,dc=no-ip,dc=org" -w admin@Password -b "uid=jsmith1,ou=People,dc=systemtracker,dc=no-ip,dc=org" "(objectclass=*)";
    sleep 5;
  
  01-default-users.ldif: |
    #####
    # Entry 3: ou=users,dc=systemtracker,dc=no-ip,dc=org
    dn: ou=users,dc=systemtracker,dc=no-ip,dc=org
    objectclass: organizationalUnit
    ou: users

    # Entry 7: uid=bgates,ou=users,dc=systemtracker,dc=no-ip,dc=org
    dn: uid=bgates,ou=users,dc=systemtracker,dc=no-ip,dc=org
    changetype: add
    cn: Bill Gates
    gidnumber: 500
    givenname: bill
    homedirectory: /home/users/bgates
    objectclass: inetOrgPerson
    sn: gates
    uid: bgates
    uidnumber: 1000
    userPassword:: e1NTSEF9a2xnWTRQQm5CYWptc2VncUNjMXdsWS9ZeHNyL200OFU=
